---
DATE: 2025-10-07
AUTHOR: Claude Code AI Assistant
PROJECT: The HOLE Foundation - US Transparency Laws Database
SUBPROJECT: Vector Database Quick Start Guide
VERSION: v0.13
---

# v0.13 Vector Database - Quick Start Guide

## Prerequisites

✅ You have access to Supabase project: `rggwmedruufdbuifxbov` (HOLE Truth Project)
✅ Migration file created: `supabase/migrations/20251015000000_add_vector_database.sql`
✅ OpenAI API key for embedding generation (set up later)

## Step 1: Apply the Migration (5 minutes)

### Option A: Using Supabase CLI (Recommended)

```bash
# Navigate to project root
cd /Volumes/HOLE-RAID-DRIVE/HOLE/Github/us-transparency-laws-database

# Verify you're linked to correct project
cat supabase/.temp/project-ref
# Should output: rggwmedruufdbuifxbov

# Apply migration
npx supabase db push

# You should see:
# ✔ Applying migration 20251015000000_add_vector_database.sql...
# ✔ Finished supabase db push.
```

### Option B: Using Supabase Dashboard

1. Go to https://supabase.com/dashboard/project/rggwmedruufdbuifxbov
2. Navigate to **SQL Editor**
3. Copy contents of `supabase/migrations/20251015000000_add_vector_database.sql`
4. Paste and run

## Step 2: Verify Installation (2 minutes)

### Check pgvector Extension

```bash
npx supabase db shell
```

```sql
-- Check if pgvector is enabled
SELECT * FROM pg_extension WHERE extname = 'vector';

-- Should return:
-- extname | extversion | ...
-- --------|------------|-----
-- vector  | 0.7.0      | ...
```

### Check Tables Created

```sql
-- List all vector tables
SELECT table_name
FROM information_schema.tables
WHERE table_name LIKE 'foia_%'
ORDER BY table_name;

-- Should return:
-- foia_exemption_strategies
-- foia_knowledge_documents
-- foia_request_templates
-- foia_successful_examples
```

### Check Statistics View

```sql
-- Get current statistics (will show zeros until data added)
SELECT * FROM vector_database_stats;

-- Expected output:
-- table_name                   | total_documents | documents_with_embeddings | ...
-- -----------------------------|-----------------|---------------------------|-----
-- foia_knowledge_documents     | 0               | 0                         | ...
-- foia_request_templates       | 0               | 0                         | ...
-- foia_exemption_strategies    | 0               | 0                         | ...
-- foia_successful_examples     | 0               | 0                         | ...
```

### Check Indexes

```sql
-- Verify HNSW and GIN indexes created
SELECT
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename LIKE 'foia_%'
ORDER BY tablename, indexname;

-- Should return 16 indexes:
-- - 4 HNSW indexes (one per table for embeddings)
-- - 4 GIN indexes (one per table for full-text search)
-- - 8 compound indexes (jurisdiction, tags, etc.)
```

### Check Hybrid Search Function

```sql
-- Test search function exists
SELECT proname, proargnames
FROM pg_proc
WHERE proname = 'search_foia_knowledge';

-- Should return:
-- proname               | proargnames
-- ----------------------|-------------------------------------------
-- search_foia_knowledge | {query_text,query_embedding,target_jurisdiction,limit_results,...}
```

## Step 3: Add Your First Document (10 minutes)

### Manual Insert (for testing)

```sql
-- Insert a test document (without embedding for now)
INSERT INTO foia_knowledge_documents (
    title,
    document_type,
    jurisdiction_id,
    jurisdiction_slug,
    jurisdiction_name,
    content,
    summary,
    use_case_tags,
    confidence_score,
    citation,
    verified_by,
    verified_at
)
SELECT
    'Federal FOIA - Basic Request Template',
    'best_practices',
    j.id,
    'federal',
    'Federal',
    'When submitting a FOIA request to a federal agency, be specific about the records you seek. Include:

1. Date range for records
2. Specific subject matter
3. Names of people or programs involved
4. File numbers or case numbers if known

Example: "I request copies of all emails sent by [Official Name] between January 1, 2024 and December 31, 2024 regarding [Specific Topic]."

This specificity helps the agency locate records quickly and reduces the chance of an overly broad request being rejected.',
    'How to write a specific, effective FOIA request',
    ARRAY['basic_request', 'best_practices', 'writing_tips'],
    1.00,
    '5 U.S.C. § 552',
    'Project Lead',
    NOW()
FROM jurisdictions j
WHERE j.slug = 'federal';

-- Verify insert
SELECT id, title, document_type, jurisdiction_slug
FROM foia_knowledge_documents;
```

## Step 4: Generate Embedding (Coming Soon)

**Note**: This requires OpenAI API key setup. We'll configure this in the next phase.

For now, you can:
1. Manually generate embeddings using OpenAI API
2. Or wait for the Edge Function setup (Week 5 of implementation plan)

### Manual Embedding (if you have OpenAI API key)

```typescript
// Generate embedding using OpenAI
import OpenAI from 'openai'

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

const document = {
  title: 'Federal FOIA - Basic Request Template',
  content: '...' // full content from above
}

const embedding = await openai.embeddings.create({
  model: 'text-embedding-3-small',
  input: `${document.title}\n\n${document.content}`
})

// Update database with embedding
await supabase
  .from('foia_knowledge_documents')
  .update({ embedding: embedding.data[0].embedding })
  .eq('title', document.title)
```

## Step 5: Test Search (After Embeddings Added)

### Keyword Search Only (Works Now)

```sql
-- Search using full-text search (no embedding needed)
SELECT
    title,
    document_type,
    ts_rank(content_fts, websearch_to_tsquery('english', 'FOIA request template')) AS rank
FROM foia_knowledge_documents
WHERE content_fts @@ websearch_to_tsquery('english', 'FOIA request template')
ORDER BY rank DESC
LIMIT 5;
```

### Hybrid Search (After Embeddings)

```sql
-- Test hybrid search function
-- (Requires query_embedding vector - generate via OpenAI API)
SELECT *
FROM search_foia_knowledge(
    'how to write a good FOIA request',  -- query text
    '[...]'::vector(1536),                -- query embedding (1536 floats)
    'federal',                            -- jurisdiction filter
    5                                     -- limit results
);
```

## Step 6: Configure API Access

### Get API Keys

```bash
npx supabase projects api-keys --project-ref rggwmedruufdbuifxbov
```

Output:
```
anon         | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
service_role | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Configure Environment Variables

Create `.env.local` in your application:

```bash
# Supabase (already configured)
NEXT_PUBLIC_SUPABASE_URL=https://rggwmedruufdbuifxbov.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# OpenAI (for embeddings - add later)
OPENAI_API_KEY=sk-...

# Vercel AI Gateway (already configured)
VERCEL_AI_GATEWAY_API_KEY=vck_7x7LI3dpcDxFWWcMR0k3RyRwXU0rT33LwqaxXRUojYa15U4Bd305wjqC
```

## Troubleshooting

### Issue: "extension vector is not available"

**Solution**: pgvector might not be enabled on your plan.

```sql
-- Check available extensions
SELECT * FROM pg_available_extensions WHERE name = 'vector';

-- If not available, you're on a plan that doesn't include pgvector
-- Contact Supabase support or upgrade plan
```

### Issue: "function search_foia_knowledge does not exist"

**Solution**: Migration might not have applied completely.

```sql
-- Check if function exists
SELECT proname FROM pg_proc WHERE proname = 'search_foia_knowledge';

-- If empty, re-run the migration
-- Copy Part 7 of migration file and execute manually
```

### Issue: "could not access file "$libdir/vector""

**Solution**: pgvector extension files not installed on database.

This requires Supabase support. Open a ticket mentioning:
- Project ref: rggwmedruufdbuifxbov
- Issue: pgvector extension not available
- Requested: Enable pgvector extension

### Issue: Slow vector searches

**Solution**: Check HNSW indexes are created.

```sql
-- List indexes
SELECT indexname, indexdef
FROM pg_indexes
WHERE indexname LIKE '%embedding%';

-- If missing, create manually:
CREATE INDEX idx_knowledge_docs_embedding
ON foia_knowledge_documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

## Next Steps

### Immediate (This Week)

1. ✅ Migration applied
2. ✅ Tables verified
3. ⏳ Add first test documents (manual)
4. ⏳ Verify keyword search works

### Phase 2 (Weeks 2-4): Data Curation

See [`v0.13-VECTOR_DATABASE_DESIGN.md`](./v0.13-VECTOR_DATABASE_DESIGN.md) for detailed data curation workflow.

**Goal**: 270 high-quality documents
- 35 Federal documents
- 25 California documents
- 25 documents each for 9 other priority states

### Phase 3 (Week 5): Embedding Generation

1. Create Supabase Edge Function
2. Configure OpenAI API key
3. Batch generate embeddings
4. Verify search quality

### Phase 4 (Week 6): FOIA Generator Integration

1. Update FOIA Generator to query vector database
2. Add context retrieval to LLM prompts
3. Test with real user queries
4. Deploy to production

## Monitoring

### Check Database Size

```sql
-- Total database size
SELECT pg_size_pretty(pg_database_size(current_database()));

-- Vector table sizes
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE tablename LIKE 'foia_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### Check Index Usage

```sql
-- Index hit rate (should be >95%)
SELECT
    schemaname,
    tablename,
    indexrelname,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
  AND tablename LIKE 'foia_%'
ORDER BY idx_scan DESC;
```

### Check Query Performance

```sql
-- Slow queries (if pg_stat_statements enabled)
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE query LIKE '%foia_%'
ORDER BY mean_exec_time DESC
LIMIT 10;
```

## Resources

- **Full Design Document**: [`v0.13-VECTOR_DATABASE_DESIGN.md`](./v0.13-VECTOR_DATABASE_DESIGN.md)
- **Implementation Summary**: [`v0.13-IMPLEMENTATION_SUMMARY.md`](./v0.13-IMPLEMENTATION_SUMMARY.md)
- **Migration File**: [`../supabase/migrations/20251015000000_add_vector_database.sql`](../supabase/migrations/20251015000000_add_vector_database.sql)

## Getting Help

1. **Database Issues**: Check Supabase Dashboard logs
2. **Vector Search Issues**: Review pgvector documentation
3. **Embedding Issues**: Test OpenAI API directly
4. **Performance Issues**: Check index creation and usage

## Congratulations! 🎉

You now have a production-ready vector database for your FOIA AI agent. The foundation is set - time to start curating high-quality content that will make your AI agent exceptional.

---

**Next Milestone**: Add 35 Federal documents and verify search quality.
