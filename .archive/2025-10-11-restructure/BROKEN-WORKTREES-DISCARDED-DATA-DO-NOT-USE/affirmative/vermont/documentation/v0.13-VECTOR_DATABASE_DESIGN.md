---
DATE: 2025-10-07
AUTHOR: Claude Code AI Assistant
PROJECT: The HOLE Foundation - US Transparency Laws Database
SUBPROJECT: Vector Database for AI Agent RAG
VERSION: v0.13
---

# v0.13: Vector Database for FOIA AI Agent

## Executive Summary

This document outlines the architecture for a production-ready vector database system using Supabase pgvector to power an AI agent specialized in generating FOIA requests. The system combines structured relational data (v0.11.1) with semantic search capabilities to provide contextually relevant guidance for FOIA request generation.

## Strategic Vision

### Current State (v0.11.1)
- **Structured Tables**: Perfect for web UIs, maps, and structured queries
- **52 Jurisdictions**: Complete legal metadata for all US transparency laws
- **Human-Readable**: Optimized for display and navigation

### Target State (v0.13)
- **Vector Embeddings**: Semantic search across legal concepts and precedents
- **AI-Optimized**: High-yield datasets curated for FOIA generation
- **Hybrid Search**: Combine structured filters with semantic understanding
- **Row-Level Security**: Fine-grained access control on legal documents

### Why Both Systems?

**Structured Tables** → Web pages, maps, dropdowns, filters
**Vector Database** → AI agent context, semantic search, RAG generation

## Architecture Overview

### Technology Stack

```
┌─────────────────────────────────────────────────────────┐
│                   FOIA AI Agent                         │
│           (TheHoleTruth.org FOIA Generator)             │
└─────────────────┬───────────────────────────────────────┘
                  │
    ┌─────────────┴─────────────┐
    │                           │
    ▼                           ▼
┌───────────────┐         ┌────────────────┐
│  Structured   │         │    Vector      │
│    Tables     │         │   Database     │
│  (v0.11.1)    │         │   (v0.13)      │
└───────────────┘         └────────────────┘
    │                           │
    │     Supabase Postgres + pgvector
    └───────────────┬───────────┘
                    │
            ┌───────┴────────┐
            │                │
            ▼                ▼
      ┌──────────┐     ┌─────────┐
      │   REST   │     │ Realtime│
      │   API    │     │   (opt) │
      └──────────┘     └─────────┘
```

### Core Components

1. **pgvector Extension**: Native PostgreSQL vector storage
2. **Embedding Model**: OpenAI text-embedding-3-small (1536 dimensions)
3. **Hybrid Search**: Combine keyword (tsvector) + semantic (pgvector)
4. **Row-Level Security**: Permission-based document access
5. **ACID Compliance**: Vectors and source data always synchronized

## Database Schema Design

### 1. Knowledge Base Documents Table

```sql
CREATE TABLE foia_knowledge_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Document Metadata
    title TEXT NOT NULL,
    document_type TEXT NOT NULL CHECK (document_type IN (
        'statute_text',           -- Full statutory text
        'exemption_guidance',     -- How to navigate exemptions
        'right_of_access',        -- Affirmative rights explanation
        'successful_request',     -- Template/example of successful request
        'appeal_strategy',        -- How to appeal denials
        'fee_waiver_guidance',    -- How to request fee waivers
        'timing_strategy',        -- How to leverage response deadlines
        'agency_specific_tips',   -- Agency-specific advice
        'case_law_summary',       -- Relevant court decisions
        'best_practices'          -- General FOIA best practices
    )),

    -- Jurisdiction Linking
    jurisdiction_id UUID REFERENCES jurisdictions(id) ON DELETE CASCADE,
    jurisdiction_slug TEXT NOT NULL,
    jurisdiction_name TEXT NOT NULL,

    -- Document Content
    content TEXT NOT NULL,                    -- Full document text
    summary TEXT,                             -- AI-generated summary (optional)
    key_points JSONB,                         -- Structured key takeaways

    -- Search Optimization
    content_fts tsvector GENERATED ALWAYS AS (
        to_tsvector('english', coalesce(title, '') || ' ' || coalesce(content, '') || ' ' || coalesce(summary, ''))
    ) STORED,                                 -- Full-text search vector
    embedding vector(1536),                   -- OpenAI embedding

    -- Metadata for AI Agent
    use_case_tags TEXT[],                     -- ['fee_waiver', 'expedited_processing', 'privacy_exemption']
    confidence_score DECIMAL(3,2),            -- 0.00-1.00 quality rating
    citation TEXT,                            -- Source citation
    verified_by TEXT,                         -- Who verified this document
    verified_at TIMESTAMPTZ,

    -- Access Control
    is_public BOOLEAN NOT NULL DEFAULT true,
    owner_id UUID,                            -- For user-submitted examples

    -- Timestamps
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 2. FOIA Request Templates Table

```sql
CREATE TABLE foia_request_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Template Metadata
    template_name TEXT NOT NULL,
    description TEXT,

    -- Jurisdiction Linking
    jurisdiction_id UUID REFERENCES jurisdictions(id) ON DELETE CASCADE,
    jurisdiction_slug TEXT NOT NULL,

    -- Template Content
    template_text TEXT NOT NULL,              -- Full template with {{placeholders}}
    required_fields JSONB,                    -- {'requester_name': 'string', 'agency_name': 'string'}
    optional_fields JSONB,

    -- Search Optimization
    template_fts tsvector GENERATED ALWAYS AS (
        to_tsvector('english', coalesce(template_name, '') || ' ' || coalesce(description, ''))
    ) STORED,
    embedding vector(1536),

    -- Template Metadata
    use_cases TEXT[],                         -- ['expedited', 'fee_waiver', 'privacy']
    difficulty_level TEXT CHECK (difficulty_level IN ('beginner', 'intermediate', 'advanced')),
    success_rate DECIMAL(3,2),                -- Based on usage feedback
    usage_count INTEGER DEFAULT 0,

    -- Example Requests
    example_filled TEXT,                      -- Filled-out example
    example_response TEXT,                    -- What response looked like

    -- Timestamps
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 3. FOIA Exemption Strategies Table

```sql
CREATE TABLE foia_exemption_strategies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Link to existing exemption
    exemption_id UUID REFERENCES exemptions(id) ON DELETE CASCADE,
    jurisdiction_slug TEXT NOT NULL,

    -- Strategy Content
    exemption_name TEXT NOT NULL,
    strategy_title TEXT NOT NULL,
    strategy_content TEXT NOT NULL,           -- How to overcome/navigate this exemption

    -- Search Optimization
    strategy_fts tsvector GENERATED ALWAYS AS (
        to_tsvector('english', coalesce(strategy_title, '') || ' ' || coalesce(strategy_content, ''))
    ) STORED,
    embedding vector(1536),

    -- Strategy Metadata
    success_rate DECIMAL(3,2),
    alternative_approaches TEXT[],
    case_law_citations TEXT[],

    -- Timestamps
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 4. Successful Request Examples Table

```sql
CREATE TABLE foia_successful_examples (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Request Details
    request_subject TEXT NOT NULL,
    jurisdiction_slug TEXT NOT NULL,
    agency_name TEXT,

    -- Request and Response
    request_text TEXT NOT NULL,               -- The actual request sent
    response_summary TEXT,                    -- What they received
    timeline_days INTEGER,                    -- How long it took

    -- Search Optimization
    content_fts tsvector GENERATED ALWAYS AS (
        to_tsvector('english', coalesce(request_subject, '') || ' ' || coalesce(request_text, '') || ' ' || coalesce(response_summary, ''))
    ) STORED,
    embedding vector(1536),

    -- Metadata
    challenges_faced TEXT[],                  -- What obstacles came up
    strategies_used TEXT[],                   -- How they overcame them
    lessons_learned TEXT,

    -- Privacy
    anonymized BOOLEAN NOT NULL DEFAULT true,
    contributed_by UUID,                      -- User who shared (optional)

    -- Timestamps
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

## Indexes and Performance

### Vector Indexes (HNSW)

```sql
-- HNSW indexes for fast vector similarity search
-- m=16, ef_construction=64 are optimal for most use cases

CREATE INDEX idx_knowledge_docs_embedding ON foia_knowledge_documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

CREATE INDEX idx_templates_embedding ON foia_request_templates
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

CREATE INDEX idx_strategies_embedding ON foia_exemption_strategies
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

CREATE INDEX idx_examples_embedding ON foia_successful_examples
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

### Full-Text Search Indexes (GIN)

```sql
-- GIN indexes for fast keyword search
CREATE INDEX idx_knowledge_docs_fts ON foia_knowledge_documents USING GIN (content_fts);
CREATE INDEX idx_templates_fts ON foia_request_templates USING GIN (template_fts);
CREATE INDEX idx_strategies_fts ON foia_exemption_strategies USING GIN (strategy_fts);
CREATE INDEX idx_examples_fts ON foia_successful_examples USING GIN (content_fts);
```

### Compound Indexes

```sql
-- Jurisdiction filtering
CREATE INDEX idx_knowledge_docs_jurisdiction ON foia_knowledge_documents(jurisdiction_slug, document_type);
CREATE INDEX idx_templates_jurisdiction ON foia_request_templates(jurisdiction_slug);

-- Use case filtering
CREATE INDEX idx_knowledge_docs_tags ON foia_knowledge_documents USING GIN (use_case_tags);
CREATE INDEX idx_templates_use_cases ON foia_request_templates USING GIN (use_cases);
```

## Hybrid Search Functions

### Combined Semantic + Keyword Search

```sql
CREATE OR REPLACE FUNCTION search_foia_knowledge(
    query_text TEXT,
    query_embedding vector(1536),
    target_jurisdiction TEXT DEFAULT NULL,
    limit_results INTEGER DEFAULT 10
)
RETURNS TABLE (
    id UUID,
    title TEXT,
    document_type TEXT,
    content TEXT,
    jurisdiction_name TEXT,
    relevance_score FLOAT
) AS $$
BEGIN
    RETURN QUERY
    WITH semantic_search AS (
        SELECT
            d.id,
            1 - (d.embedding <=> query_embedding) AS semantic_score,
            ROW_NUMBER() OVER (ORDER BY d.embedding <=> query_embedding) AS semantic_rank
        FROM foia_knowledge_documents d
        WHERE target_jurisdiction IS NULL OR d.jurisdiction_slug = target_jurisdiction
        ORDER BY d.embedding <=> query_embedding
        LIMIT limit_results * 2
    ),
    keyword_search AS (
        SELECT
            d.id,
            ts_rank(d.content_fts, websearch_to_tsquery('english', query_text)) AS keyword_score,
            ROW_NUMBER() OVER (ORDER BY ts_rank(d.content_fts, websearch_to_tsquery('english', query_text)) DESC) AS keyword_rank
        FROM foia_knowledge_documents d
        WHERE d.content_fts @@ websearch_to_tsquery('english', query_text)
          AND (target_jurisdiction IS NULL OR d.jurisdiction_slug = target_jurisdiction)
        ORDER BY ts_rank(d.content_fts, websearch_to_tsquery('english', query_text)) DESC
        LIMIT limit_results * 2
    ),
    -- Reciprocal Rank Fusion (RRF)
    combined AS (
        SELECT
            COALESCE(s.id, k.id) AS doc_id,
            (COALESCE(1.0 / (60 + s.semantic_rank), 0.0) +
             COALESCE(1.0 / (60 + k.keyword_rank), 0.0)) AS rrf_score
        FROM semantic_search s
        FULL OUTER JOIN keyword_search k ON s.id = k.id
    )
    SELECT
        d.id,
        d.title,
        d.document_type,
        d.content,
        d.jurisdiction_name,
        c.rrf_score AS relevance_score
    FROM combined c
    JOIN foia_knowledge_documents d ON c.doc_id = d.id
    ORDER BY c.rrf_score DESC
    LIMIT limit_results;
END;
$$ LANGUAGE plpgsql;
```

## Row-Level Security (RLS)

### Public Read Access

```sql
-- Enable RLS on all tables
ALTER TABLE foia_knowledge_documents ENABLE ROW LEVEL SECURITY;
ALTER TABLE foia_request_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE foia_exemption_strategies ENABLE ROW LEVEL SECURITY;
ALTER TABLE foia_successful_examples ENABLE ROW LEVEL SECURITY;

-- Public documents are readable by anyone
CREATE POLICY "Public documents are viewable by everyone"
    ON foia_knowledge_documents FOR SELECT
    USING (is_public = true);

-- User-contributed documents are only viewable by owner or if public
CREATE POLICY "Users can view their own documents"
    ON foia_knowledge_documents FOR SELECT
    USING (auth.uid() = owner_id OR is_public = true);

-- Users can insert their own documents
CREATE POLICY "Users can create their own documents"
    ON foia_knowledge_documents FOR INSERT
    WITH CHECK (auth.uid() = owner_id);

-- Templates are always public
CREATE POLICY "Templates are viewable by everyone"
    ON foia_request_templates FOR SELECT
    USING (true);

-- Strategies are always public
CREATE POLICY "Strategies are viewable by everyone"
    ON foia_exemption_strategies FOR SELECT
    USING (true);

-- Anonymized examples are public
CREATE POLICY "Anonymized examples are viewable by everyone"
    ON foia_successful_examples FOR SELECT
    USING (anonymized = true OR auth.uid() = contributed_by);
```

## Data Curation Workflow

### Phase 1: Foundation (Priority 1 Jurisdictions)

**Target**: Federal + 10 high-impact states (CA, NY, TX, FL, IL, WA, MA, OR, CT, NJ)

#### 1.1 Statute Text Documents
- Extract key sections from existing `data/federal/jurisdiction-data.json` and state equivalents
- Create focused documents for each major statutory section
- Tag with relevant use cases

```json
{
  "title": "Federal FOIA - Fee Waiver Provisions (5 USC § 552(a)(4)(A)(iii))",
  "document_type": "statute_text",
  "jurisdiction_slug": "federal",
  "content": "The full text of the fee waiver section...",
  "summary": "Federal agencies must waive fees when disclosure primarily benefits the public interest and is not primarily in the commercial interest of the requester.",
  "key_points": {
    "public_interest_factors": ["Contribution to public understanding", "Disclosure subject matter", "Significance of information"],
    "commercial_interest_factors": ["Requester identity", "Intent to use information for profit"]
  },
  "use_case_tags": ["fee_waiver", "cost_reduction", "public_interest"],
  "confidence_score": 1.00,
  "citation": "5 U.S.C. § 552(a)(4)(A)(iii)",
  "verified_by": "Project Lead",
  "verified_at": "2025-10-07"
}
```

#### 1.2 Exemption Guidance Documents
- For each exemption in the database, create a strategic guidance document
- Include case law, successful arguments, and workarounds

#### 1.3 Request Templates
- Create 5-10 templates per jurisdiction covering common scenarios:
  - Basic information request
  - Expedited processing request
  - Fee waiver request
  - Appeal of denial
  - Privacy Act request (federal)

#### 1.4 Best Practices Documents
- General FOIA writing tips
- How to describe records precisely
- How to establish requester identity
- How to demonstrate public interest

### Phase 2: Expansion (Priority 2 & 3 Jurisdictions)

Replicate Phase 1 content for remaining 41 jurisdictions.

### Phase 3: Community Contributions

Enable authenticated users to submit:
- Successful request examples (anonymized)
- Strategy improvements
- Template variations

All contributions reviewed before going public.

## Embedding Generation Strategy

### Model Selection: OpenAI text-embedding-3-small

**Rationale**:
- **1536 dimensions**: Optimal balance of accuracy and performance
- **Cost-effective**: $0.02 per 1M tokens
- **Legal domain**: Performs well on formal/legal text
- **API stability**: Production-ready with high uptime

### Alternative: Local Embedding Models

For cost optimization or offline capability:
- **gte-small** (384 dimensions): Supported by Supabase natively
- **bge-base-en-v1.5** (768 dimensions): Strong on English legal text

### Embedding Generation Workflow

```typescript
// Supabase Edge Function: generate-embeddings
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import OpenAI from 'https://esm.sh/openai@4'

serve(async (req) => {
  const { documentId, text } = await req.json()

  const openai = new OpenAI({
    apiKey: Deno.env.get('OPENAI_API_KEY')
  })

  // Generate embedding
  const embedding = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: text,
    encoding_format: 'float'
  })

  // Store in database
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL'),
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
  )

  const { error } = await supabase
    .from('foia_knowledge_documents')
    .update({ embedding: embedding.data[0].embedding })
    .eq('id', documentId)

  if (error) throw error

  return new Response(JSON.stringify({ success: true }), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

## AI Agent Query Patterns

### Pattern 1: Jurisdiction-Specific Guidance

```typescript
// User: "How do I request fee waiver in California?"

// Step 1: Generate embedding for query
const queryEmbedding = await openai.embeddings.create({
  model: 'text-embedding-3-small',
  input: 'How do I request fee waiver in California?'
})

// Step 2: Hybrid search
const { data } = await supabase.rpc('search_foia_knowledge', {
  query_text: 'fee waiver California',
  query_embedding: queryEmbedding.data[0].embedding,
  target_jurisdiction: 'california',
  limit_results: 5
})

// Step 3: Provide context to LLM
const context = data.map(doc => doc.content).join('\n\n')
const prompt = `Using the following California-specific information:\n\n${context}\n\nAnswer: How do I request a fee waiver in California?`
```

### Pattern 2: Cross-Jurisdiction Comparison

```typescript
// User: "Compare response timelines between Federal and Texas"

// Step 1: Retrieve structured data (from v0.11.1 tables)
const { data: timelines } = await supabase
  .from('response_requirements')
  .select(`
    jurisdiction_id,
    jurisdictions(name),
    standard_response_days,
    expedited_response_days
  `)
  .in('jurisdictions.slug', ['federal', 'texas'])

// Step 2: Search for timing strategy documents
const { data: strategies } = await supabase.rpc('search_foia_knowledge', {
  query_text: 'response timeline deadline strategy federal texas',
  query_embedding: await getEmbedding('response timeline deadline strategy'),
  limit_results: 3
})

// Step 3: Combine structured + semantic
const response = {
  structured: timelines,
  strategies: strategies,
  recommendation: "Generated by LLM using both data sources"
}
```

### Pattern 3: Exemption Navigation

```typescript
// User: "The agency claimed Exemption 5, what can I do?"

// Step 1: Identify exemption from structured data
const { data: exemption } = await supabase
  .from('exemptions')
  .select('*, foia_exemption_strategies(*)')
  .eq('category', 'Exemption 5')
  .single()

// Step 2: Find successful examples
const { data: examples } = await supabase.rpc('search_foia_knowledge', {
  query_text: 'overcome Exemption 5 deliberative process',
  query_embedding: await getEmbedding('overcome Exemption 5'),
  limit_results: 5
})

// Step 3: Generate appeal strategy
```

## Implementation Checklist

### Phase 1: Database Setup (Week 1)

- [ ] Create migration file: `20251015000000_add_vector_database.sql`
- [ ] Enable pgvector extension
- [ ] Create all 4 vector tables
- [ ] Create indexes (HNSW + GIN)
- [ ] Create hybrid search functions
- [ ] Apply RLS policies
- [ ] Deploy to production

### Phase 2: Data Curation (Weeks 2-4)

- [ ] Federal statute text documents (10 docs)
- [ ] Federal exemption guidance (9 docs - one per exemption)
- [ ] Federal request templates (10 templates)
- [ ] California documents (25 docs)
- [ ] Repeat for 9 other priority states (225 docs)

### Phase 3: Embedding Generation (Week 5)

- [ ] Create Edge Function for embedding generation
- [ ] Set up OpenAI API key in Supabase secrets
- [ ] Batch generate embeddings for all documents
- [ ] Verify vector search performance
- [ ] Test hybrid search functions

### Phase 4: AI Agent Integration (Week 6)

- [ ] Create TypeScript client for vector queries
- [ ] Implement query patterns in FOIA Generator
- [ ] Add context retrieval to LLM prompts
- [ ] Test with real user queries
- [ ] Optimize retrieval parameters (topK, thresholds)

### Phase 5: Monitoring & Optimization (Ongoing)

- [ ] Track query performance metrics
- [ ] Monitor embedding generation costs
- [ ] Collect user feedback on result quality
- [ ] Iterate on document curation
- [ ] Expand to remaining jurisdictions

## Cost Estimation

### Embedding Generation (One-Time)

**Phase 1** (Federal + 10 states = ~270 documents)
- Average document length: 2000 tokens
- Total tokens: 270 × 2000 = 540,000 tokens
- Cost: $0.02 per 1M tokens = **$0.01**

**Full Database** (52 jurisdictions = ~1400 documents)
- Total tokens: 1400 × 2000 = 2,800,000 tokens
- Cost: **$0.06**

### Query Costs (Ongoing)

**Per query**:
- Embedding generation: 50 tokens average
- Cost per query: $0.000001 (negligible)

**10,000 queries/month**:
- Monthly cost: **$0.01**

### Storage

**pgvector storage** (1536-dimension vectors):
- Per vector: ~6KB
- 1400 documents: 8.4 MB
- Supabase free tier: 500MB included ✅

## Success Metrics

### Quantitative

1. **Retrieval Accuracy**
   - Target: >90% of relevant documents in top-5 results
   - Measure: User feedback on result relevance

2. **Query Latency**
   - Target: <500ms for hybrid search
   - Measure: p95 response time

3. **Generation Quality**
   - Target: >80% of generated requests are "ready to send"
   - Measure: User edits before submission

### Qualitative

1. **User Feedback**
   - "Did this help you write your request?"
   - Net Promoter Score (NPS)

2. **Document Coverage**
   - % of user queries that find relevant documents
   - Gaps in knowledge base identified

## Future Enhancements (v0.14+)

1. **Multi-Modal Embeddings**
   - Embed images of redacted documents
   - Visual similarity search for common redaction patterns

2. **Conversation Memory**
   - Store user's previous queries and requests
   - Personalized recommendations

3. **Feedback Loop**
   - Track which suggestions users accept/reject
   - Continuously improve retrieval parameters

4. **Community Knowledge**
   - User-contributed successful examples
   - Upvoting/downvoting of strategies

5. **Real-Time Updates**
   - Monitor for law changes
   - Automatically re-embed updated documents

## References

### Technical Documentation

- [Supabase Vector Documentation](https://supabase.com/docs/guides/ai)
- [pgvector GitHub](https://github.com/pgvector/pgvector)
- [OpenAI Embeddings Guide](https://platform.openai.com/docs/guides/embeddings)

### Research Papers

- [Retrieval-Augmented Generation (RAG)](https://arxiv.org/abs/2005.11401)
- [Dense Passage Retrieval](https://arxiv.org/abs/2004.04906)
- [HNSW: Efficient and Robust Approximate Nearest Neighbor Search](https://arxiv.org/abs/1603.09320)

### Best Practices

- [Supabase RAG with Permissions](https://supabase.com/docs/guides/ai/rag-with-permissions)
- [Hybrid Search in PostgreSQL](https://supabase.com/docs/guides/ai/hybrid-search)
- [Reciprocal Rank Fusion](https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf)

---

**Next Steps**: Review this design with stakeholders, then proceed with Phase 1 implementation (database setup).
